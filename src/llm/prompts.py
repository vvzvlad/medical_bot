"""Prompts for LLM command processing."""

# Timezone cities list for timezone_change command
TIMEZONE_CITIES = """
Калининград: +02:00
Москва: +03:00
Санкт-Петербург: +03:00
Тверь: +03:00
Брянск: +03:00
Воронеж: +03:00
Курск: +03:00
Белгород: +03:00
Смоленск: +03:00
Ярославль: +03:00
Кострома: +03:00
Вологда: +03:00
Архангельск: +03:00
Мурманск: +03:00
Нижний Новгород: +03:00
Киров: +03:00
Волгоград: +03:00
Саратов: +04:00
Астрахань: +04:00
Ульяновск: +04:00
Екатренбург: +05:00
Пермь: +05:00
Оренбург: +05:00
Тюмень: +05:00
Челябинск: +05:00
Омск: +06:00
Новосибирск: +07:00
Томск: +07:00
Кемерово: +07:00
Барнаул: +07:00
Краснояск: +07:00
Иркутск: +08:00
Улан-Удэ: +08:00
Чита: +09:00
Якутск: +09:00
Владивосток: +10:00
Хабаровск: +10:00
Магадан: +11:00
Петропавловск-Камчатский: +12:00
Киев (Украина): +02:00
Львов (Украина): +02:00
Харьков (Украина): +02:00
Кишинёв (Молдавия): +02:00
Минск (Беларусь): +03:00
Баку (Азербайджан): +04:00
Ереван (Армения): +04:00
Тбилиси (Грузия): +04:00
Ташкент (Узбекистан): +05:00
Бухара (Узбекистан): +05:00
Ашхабад (Туркменистан): +05:00
Душанбе (Таджикистан): +05:00
Актау (Казахстан): +05:00
Алматы (Казахстан): +06:00
Астана/Нур-Султан (Казахстан): +06:00
Бишкек (Кыргызстан): +06:00

Лиссабон (Португалия): +00:00
Лондон (Великобритания): +00:00
Дублин (Ирландия): +00:00
Мадрид (Испания): +01:00
Барселона (Испания): +01:00
Париж (Франция): +01:00
Марсель (Франция): +01:00
Лион (Франция): +01:00
Амстердам (Нидерланды): +01:00
Брюссель (Бельгия): +01:00
Люксембург: +01:00
Берлин (Германия): +01:00
Мюнхен (Германия): +01:00
Кёльн (Германия): +01:00
Цюрих (Швейцария): +01:00
Берн (Швейцария): +01:00
Вена (Австрия): +01:00
Прага (Чешская Республика): +01:00
Братислава (Словакия): +01:00
Варшава (Польша): +01:00
Краков (Польша): +01:00
Осло (Норвегия): +01:00
Стокгольм (Швеция): +01:00
Копенгаген (Дания): +01:00
Будапешт (Венгрия): +01:00
Любляна (Словения): +01:00
Загреб (Хорватия): +01:00
Белград (Сербия): +01:00
Рим (Италия): +01:00
Милан (Италия): +01:00
Венеция (Италия): +01:00
Вильнюс (Литва): +02:00
Рига (Латвия): +02:00
Таллинн (Эстония): +02:00
София (Болгария): +02:00
Бухарест (Румыния): +02:00
Афины (Греция): +02:00
Никосия (Кипр): +02:00
Хельсинки (Финляндия): +02:00
"""


def get_command_detection_prompt(user_message: str) -> str:
    """Generate first-stage prompt for command type detection.
    
    Args:
        user_message: User's message text
        
    Returns:
        System prompt for command type detection
    """
    return f"""Ты ассистент для управления приемом медикаментов. Пользователь отправил сообщение.
Определи тип команды из следующих вариантов:
- add: добавление нового медикамента (фразы типа "я принимаю X", "добавь X", "мне надо принимать X")
- delete: удаление медикамента (фразы типа "удали X", "больше не принимаю X", "убери X")
- time_change: изменение времени приема СУЩЕСТВУЮЩЕГО медикамента (фразы типа "измени время X", "X теперь в Y", "перенеси X на Y")
- dose_change: изменение дозировки (фразы типа "измени дозировку X", "X теперь N мг")
- timezone_change: изменение часового пояса (фразы типа "моя часовая зона", "я в городе X")
- list: показать текущее расписание (фразы типа "что я принимаю", "покажи расписание", "список")
- done: отметить прием медикамента раньше времени (фразы типа "я принял X", "выпил X", "готово")
- unknown: неизвестная команда

ВАЖНО: Если пользователь говорит "я принимаю X в Y" - это ВСЕГДА добавление нового медикамента (add), даже если такой медикамент уже есть в расписании.
Изменение времени (time_change) - это когда пользователь явно говорит "измени", "теперь", "перенеси".

Сообщение пользователя: {user_message}

Верни ответ в формате JSON: {{"command_type": "тип_команды"}}"""


def get_add_command_prompt(user_message: str) -> str:
    """Generate prompt for parsing add command.
    
    Args:
        user_message: User's message text
        
    Returns:
        System prompt for add command parsing
    """
    return f"""Ты ассистент приема медикаментов. Пользователь хочет добавить новый медикамент в расписание.

Он написал сообщение: {user_message}

Определи название медикамента, время приема и дозировку.
Если дозировка не указана, то не указывай ее в ответе.
Время приема может быть указано несколько раз (например, "в 10:00 и 18:00").

ВАЖНО: Если пользователь упоминает несколько разных медикаментов (например, "аспирин и лоперамид"), верни массив объектов.
Если один медикамент - верни массив с одним объектом.

Примеры:
- "мне надо принимать аспирин в 19:00" -> [{{"medication_name": "Аспирин", "times": ["19:00"]}}]
- "я принимаю парацетамол 200 мг в 10:00 и 18:00" -> [{{"medication_name": "Парацетамол", "times": ["10:00", "18:00"], "dosage": "200 мг"}}]
- "добавь витамин D по 2 капсулы в 9 утра" -> [{{"medication_name": "Витамин D", "times": ["09:00"], "dosage": "2 капсулы"}}]
- "мне надо принимать аспирин и лоперамид в 12" -> [{{"medication_name": "Аспирин", "times": ["12:00"]}}, {{"medication_name": "Лоперамид", "times": ["12:00"]}}]

Ответ должен быть в формате JSON - всегда массив объектов."""


def get_delete_command_prompt(user_message: str, schedule: list) -> str:
    """Generate prompt for parsing delete command.
    
    Args:
        user_message: User's message text
        schedule: Current medication schedule with IDs
        
    Returns:
        System prompt for delete command parsing
    """
    schedule_text = "\n".join([
        f"ID {med['id']}: {med['name']} {med.get('dosage', '')} в {med['time']}"
        for med in schedule
    ])
    
    # Extract valid IDs from schedule
    valid_ids = [med['id'] for med in schedule]
    valid_ids_str = ", ".join(map(str, valid_ids))
    
    return f"""Ты ассистент приема медикаментов. Пользователь хочет удалить медикамент из расписания.

Текущее расписание пользователя:
{schedule_text}

ВАЖНО: Ты ДОЛЖЕН вернуть только ID из списка выше. НЕ придумывай новые ID.
Доступные ID в расписании: [{valid_ids_str}]

Сообщение пользователя: {user_message}

Определи:
1. Название медикамента, который пользователь хочет удалить
2. ID медикамента(ов) из расписания

ВАЖНО: Всегда возвращай поле "medication_name" с названием медикамента.

Определи, какой медикамент пользователь хочет удалить:
- Если под определение попадает один медикамент, верни его ID и название
- Если пользователь говорит "я больше не принимаю аспирин" и у него несколько аспиринов, верни все их ID и название
- Если непонятно какой именно медикамент удалять (например, несколько аспиринов с разным временем), попроси уточнить
- Если пользователь просит удалить медикамент, которого нет в списке, верни: {{"status": "not_found", "medication_name": "название", "medication_ids": []}}

Примеры ответов:
- Успешное удаление одного: {{"status": "success", "medication_name": "Аспирин", "medication_ids": [1]}}
- Успешное удаление всех с одним названием: {{"status": "success", "medication_name": "Героин", "medication_ids": [4, 5, 6, 7]}}
- Требуется уточнение: {{"status": "clarification_needed", "medication_name": "Аспирин", "message": "Вы принимаете аспирин в 19:00 и аспирин в 21:00, уточните, какой именно вы хотите удалить"}}
- Медикамент не найден: {{"status": "not_found", "medication_name": "Ибупрофен", "medication_ids": []}}

Ответ должен быть в формате JSON."""


def get_time_change_command_prompt(user_message: str, schedule: list) -> str:
    """Generate prompt for parsing time change command.
    
    Args:
        user_message: User's message text
        schedule: Current medication schedule with IDs
        
    Returns:
        System prompt for time change command parsing
    """
    schedule_text = "\n".join([
        f"ID {med['id']}: {med['name']} {med.get('dosage', '')} в {med['time']}"
        for med in schedule
    ])
    
    return f"""Ты ассистент приема медикаментов. Пользователь хочет изменить время приема медикамента.

Текущее расписание пользователя:
{schedule_text}

Сообщение пользователя: {user_message}

Определи, для какого именно медикамента он хочет поменять время приема:
- Если понятно какой медикамент (например, один аспирин в 19:00), верни его ID и новое время
- Если пользователь говорит "я принимаю аспирин в 19", а у него несколько аспиринов, попроси уточнить
- Новое время может быть указано несколько раз (например, "теперь в 10:00 и 18:00")

Примеры ответов:
- Успешное изменение: {{"status": "success", "medication_id": 1, "new_times": ["19:00", "21:00"]}}
- Требуется уточнение: {{"status": "clarification_needed", "message": "Вы принимаете аспирин в 19:00 и аспирин в 21:00, уточните, какой именно вы хотите изменить"}}

Ответ должен быть в формате JSON."""


def get_dose_change_command_prompt(user_message: str, schedule: list) -> str:
    """Generate prompt for parsing dose change command.
    
    Args:
        user_message: User's message text
        schedule: Current medication schedule with IDs
        
    Returns:
        System prompt for dose change command parsing
    """
    schedule_text = "\n".join([
        f"ID {med['id']}: {med['name']} {med.get('dosage', '')} в {med['time']}"
        for med in schedule
    ])
    
    return f"""Ты ассистент приема медикаментов. Пользователь хочет изменить дозировку медикамента.

Текущее расписание пользователя:
{schedule_text}

Сообщение пользователя: {user_message}

Определи, для какого именно медикамента он хочет поменять дозировку:
- Если понятно какой медикамент (например, один аспирин), верни его ID и новую дозировку
- Если непонятно (например, несколько аспиринов с разным временем), попроси уточнить

Примеры ответов:
- Успешное изменение: {{"status": "success", "medication_id": 1, "new_dosage": "300 мг"}}
- Требуется уточнение: {{"status": "clarification_needed", "message": "Вы принимаете аспирин в 19:00 и аспирин в 21:00, уточните, для какого именно вы хотите изменить дозировку"}}

Ответ должен быть в формате JSON."""


def get_timezone_change_command_prompt(user_message: str) -> str:
    """Generate prompt for parsing timezone change command.
    
    Args:
        user_message: User's message text
        
    Returns:
        System prompt for timezone change command parsing
    """
    return f"""Ты ассистент приема медикаментов. Пользователь хочет изменить свой часовой пояс.

Список доступных городов и их часовых поясов:
{TIMEZONE_CITIES}

Сообщение пользователя: {user_message}

Определи часовой пояс:
- Если пользователь указал город из списка, верни соответствующее смещение
- Если пользователь указал смещение напрямую (например, "+3" или "-5"), преобразуй в формат "+03:00" или "-05:00"
- Если города нет в списке, попроси указать смещение относительно UTC

Примеры ответов:
- Успешное определение: {{"status": "success", "timezone_offset": "+03:00"}}
- Требуется уточнение: {{"status": "clarification_needed", "message": "Я не знаю такого города. Пожалуйста, укажите часовой пояс в виде смещения относительно UTC, например +3 или -5"}}

Ответ должен быть в формате JSON."""


def get_done_command_prompt(user_message: str, schedule: list) -> str:
    """Generate prompt for parsing done command.
    
    Args:
        user_message: User's message text
        schedule: Current medication schedule with IDs
        
    Returns:
        System prompt for done command parsing
    """
    schedule_text = "\n".join([
        f"ID {med['id']}: {med['name']} {med.get('dosage', '')} в {med['time']}"
        for med in schedule
    ])
    
    return f"""Ты ассистент приема медикаментов. Пользователь хочет отметить, что принял медикамент.

Текущее расписание пользователя:
{schedule_text}

Сообщение пользователя: {user_message}

Определи:
1. Название медикамента, который принял пользователь
2. Время приема, если оно указано в сообщении (в формате HH:MM)
3. ID медикамента из расписания, который соответствует названию

ВАЖНО:
- Если пользователь указал время (например, "принял аспирин в 22:00"), обязательно верни это время в поле "time"
- Если время не указано, поле "time" должно быть null
- Если пользователь говорит "я принял парацетамол" без указания времени, а он принимает его несколько раз в день, верни все ID
- Если медикамент один, верни один ID

Примеры ответов:
- С указанием времени: {{"medication_name": "Аспирин", "time": "22:00", "medication_ids": [1, 3]}}
- Без указания времени: {{"medication_name": "Парацетамол", "time": null, "medication_ids": [1, 3]}}
- Медикамент не найден: {{"medication_name": "Ибупрофен", "time": null, "medication_ids": []}}

Ответ должен быть в формате JSON."""


def get_unknown_command_prompt(user_message: str) -> str:
    """Generate prompt for unknown command response.
    
    Args:
        user_message: User's message text
        
    Returns:
        System prompt for generating error message
    """
    return f"""Ты ассистент приема медикаментов. Пользователь отправил сообщение, которое не относится к управлению медикаментами.

Сообщение пользователя: {user_message}

Напиши вежливое сообщение о том, что команда не распознана, и предложи помощь.
Можешь предложить написать "что я принимаю" чтобы увидеть расписание.

Пример ответа:
{{"message": "Извините, я не понял вашу команду. Попробуйте переформулировать или напишите 'что я принимаю' чтобы увидеть ваше расписание"}}

Ответ должен быть в формате JSON."""
