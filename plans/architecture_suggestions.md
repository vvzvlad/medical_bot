# Предложения по улучшению ТЗ на Telegram-бот для управления приемом медикаментов

## Вопросы для уточнения

### 1. Первый запуск и онбординг пользователя

**Вопрос:** Как должен вести себя бот при первом взаимодействии с новым пользователем?
Ответ: Отправлять приветственное сообщение с кратким описанием возможностей, и предложением установить часовой пояс. Сообщение генерируется ллм каждый раз.

---

### 2. Формат хранения времени приема

**Вопрос:** В каком формате хранить время приема в JSON?
Ответ: Unix timestamp

**Дополнительный вопрос:** Нужно ли поддерживать прием медикаментов с интервалом (например, "каждые 6 часов")?
Ответ: Нет.
---

### 3. Множественные приемы в один день

**Вопрос:** Если пользователь принимает один и тот же медикамент несколько раз в день (например, аспирин в 10:00 и 18:00), как это хранить?

Ответ: Отдельные объекты для каждого времени приема с одинаковым названием

---

### 4. История приема медикаментов

**Вопрос:** Нужно ли хранить историю приема медикаментов?
Ответ: Не хранить историю, только текущий статус


---

### 5. Обработка пропущенных приемов

**Вопрос:** Что делать с пропущенными приемами?
Ответ: Продолжать напоминать до тех пор, пока пользователь не отметит прием, каждый час, но если пришло время приема такого же медикамента, удалить предыдущее напоминание (доза не учитывается, только название)

---

### 6. Редактирование уже отправленных напоминаний

**Вопрос:** Если пользователь изменил расписание (например, удалил медикамент), а напоминание уже отправлено, что делать?
Ответ: перестать напоминать о старом, считать что этого приема не было, и дальше работать с новым расписанием

---

### 7. Валидация данных от LLM

**Вопрос:** Как обрабатывать ситуации, когда LLM возвращает некорректные данные или не может распарсить команду?

Ответ: Отправлять пользователю сообщение об ошибке с просьбой переформулировать

---

### 8. Формат уникальных ключей медикаментов

**Вопрос:** Как генерировать уникальные ключи для медикаментов в расписании?
Ответ: Инкрементный ID (1, 2, 3...), который генерируется каждый раз при отправке в ллм, т.к. нам не нужна сквозная нумерация расписания между запросами к ллм.
---

### 9. Обработка временных зон

**Вопрос:** Как обрабатывать переход на летнее/зимнее время и изменение часового пояса пользователем?
Ответ: Хранить время в UTC и конвертировать при отображении. летнее/зимнее время не использовать, оперировать только смещением 
---

### 10. Одновременные напоминания

**Вопрос:** Если несколько медикаментов нужно принять в одно время, отправлять одно сообщение или несколько?
Ответ: при проверке расписания проверяется какие медикаменты надо принять, и если их несколько, то они комбинируются в одно сообщение

---

### 11. Формат дозировки

**Вопрос:** Нужно ли валидировать формат дозировки или принимать любой текст?
Ответ: Принимать любой текст (200 мг, 2 таблетки, 1 ложка и т.д.) или если его нет, то просто не использовать дозировку


---

### 12. Множественные устройства

**Вопрос:** Может ли один пользователь работать с ботом с разных устройств одновременно?
Ответ: никаких разных устройств нет, есть только интерфейс к боту. со скольки устройств пользователь видит сообщния в тг — тебя ебать не должно, просто присылай сообщения в бота
---

### 13. Удаление данных пользователя

**Вопрос:** Нужна ли команда для полного удаления всех данных пользователя?
Ответ: Нет, пользователь может просто перестать пользоваться ботом

---

### 14. Резервное копирование

**Вопрос:** Нужен ли механизм резервного копирования данных пользователей?
Ответ: Не предусматривать резервное копирование

---

### 15. Уведомления о системных событиях

**Вопрос:** Нужно ли уведомлять пользователя о системных событиях?
Ответ: только о тех, что касаются пользователя — об перезагрузке и логах всяких не надо, а вот о том, что ллм недоступна или команду нельзя обработать — надо
- Произошла ошибка при обработке команды
- LLM API недоступено

---

## Дополнению ТЗ

### 1. Структура данных

**Надо:** Добавить в ТЗ точную структуру JSON файла пользователя

**Пример структуры:**
```json
{
  "user_id": 123456789,
  "timezone": "Europe/Moscow",
  "medications": {
    "med_001": {
      "name": "Аспирин",
      "dosage": "200 мг",
      "schedule": ["10:00", "18:00"],
      "last_taken": {
        "10:00": "2025-12-28T07:05:00Z",
        "18:00": null
      }
    }
  },
  "last_reminder_message_id": 12345
}
```

---

### 2. Формат ответов LLM

**Надо:** Добавить в ТЗ точные JSON схемы ответов LLM для каждого типа команды

**Пример для команды `add`:**
```json
{
  "command_type": "add",
  "medication_name": "Аспирин",
  "times": ["19:00"],
  "dosage": "200 мг"
}
```

**Пример для команды `time_change` (успешный случай):**
```json
{
  "command_type": "time_change",
  "status": "success",
  "medication_key": "med_001",
  "new_times": ["19:00", "21:00"]
}
```

**Пример для команды `time_change` (требуется уточнение):**
```json
{
  "command_type": "time_change",
  "status": "clarification_needed",
  "message": "Вы принимаете аспирин в 19:00 и аспирин в 21:00, уточните, какой именно вы хотите изменить"
}
```

---

### 3. Системные промпты для LLM

**Надо:** Добавить в ТЗ полные системные промпты для каждого этапа обработки

**Промпт для определения типа команды:**
```
Ты ассистент для управления приемом медикаментов. Пользователь отправил сообщение. 
Определи тип команды из следующих вариантов:
- add: добавление нового медикамента
- delete: удаление медикамента
- time_change: изменение времени приема
- dose_change: изменение дозировки
- timezone_change: изменение часового пояса
- list: показать текущее расписание
- done: отметить прием медикамента раньше времени

Сообщение пользователя: {user_message}

Верни ответ в формате JSON: {"command_type": "тип_команды"}
```

**Промпт для команды `add`:**
```
Ты ассистент приема медикаментов. Пользователь хочет добавить новый медикамент в расписание.

Сообщение пользователя: {user_message}

Определи:
1. Название медикамента
2. Время приема (массив в формате HH:MM)
3. Дозировку (если указана)

Если дозировка не указана, не включай поле "dosage" в ответ.

Верни ответ в формате JSON:
{
  "medication_name": "название",
  "times": ["HH:MM", "HH:MM"],
  "dosage": "дозировка" (опционально)
}
```

---

### 4. Обработка ошибок и граничных случаев

**надо:** Добавить раздел с описанием обработки граничных случаев

**Примеры:**
- Пользователь пытается добавить медикамент, который уже есть в расписании
- Пользователь пытается удалить медикамент, которого нет в расписании
- Пользователь отправляет сообщение, которое LLM не может распознать
- Файл JSON пользователя поврежден
- Telegram API возвращает ошибку при отправке сообщения
- Groq API возвращает ошибку (в том числе о нехватке среддств на счету) или таймаут

---

### 5. Логирование

**надо:** Добавить требования к логированию

**Что логировать:**
- Все входящие сообщения от пользователей (с user_id)
- Все запросы к LLM и ответы
- Все изменения в расписаниях пользователей
- Все отправленные напоминания
- Все ошибки и исключения
- Время выполнения критических операций

**Формат логов:**
- Структурированные JSON логи
- Уровни: DEBUG, INFO, WARNING, ERROR, CRITICAL

---

### 6. Тестирование

**Надо:** Добавить требования к тестированию

**Типы тестов:**
- Unit тесты для бизнес-логики
- Интеграционные тесты для работы с LLM
- Тесты для проверки корректности парсинга команд
- Тесты для проверки системы напоминаний
- Тесты для проверки изоляции данных пользователей

---
---


### 9. Мониторинг и метрики

**надо:** Добавить требования к мониторингу

**Метрики:**
- Количество активных пользователей
- Количество отправленных напоминаний
- Процент принятых медикаментов
- Количество запросов к LLM
- Количество ошибок API
- Время работы бота (uptime)



---

### 10. Документация

**надо:** Добавить требования к документации

**Типы документации:**
- README что это вообще такое
- Документация API (если есть внешние интеграции)
- Описание структуры проекта

---


### 13. Интернационализация (i18n)

**Вопрос:** Нужна ли поддержка нескольких языков?
- Только русский язык


---

---

### 15. Список городов и временных зон

**Предложение:** Добавить в ТЗ список городов и их временных зон для команды `timezone_change`
да, добавить надо в формате "город:смещение"
---