Спроектируй архитектуру системы для Telegram-бота напоминаний о приеме медикаментов на Python с SQLite. Бот работает без графического интерфейса и кнопок тг бота, все команды пользователя обрабатываются через LLM-парсинг. Единственная кнопка это "принял"

АРХИТЕКТУРА ОБРАБОТКИ СООБЩЕНИЙ

Двухэтапная LLM-обработка для каждого входящего сообщения: первая LLM выполняет классификацию намерения пользователя, определяя тип команды; вторая LLM с кастомизированным промптом извлекает конкретные параметры на основе типа команды и текущего состояния расписания пользователя.

ЛОГИКА УВЕДОМЛЕНИЙ И НАПОМИНАНИЙ

Циклические суточные уведомления в установленное время. После отправки уведомления активируется почасовая система повторных напоминаний до момента подтверждения приема через кнопку "принял". При наличии двух приемов одного медикамента с разными временами: первое напоминание повторяется каждый час до наступления времени второго приема, затем первый автоматически считается принятым, система переключается на напоминания о втором приеме, при подтверждении любого напоминния все уведомления останавливаются до следующего суточного цикла. 
Добавление медикамента начинает уведомления со следующего соответствующего цикла, а не немедленно. 
Система корректно обрабатывает переходы через полночь и работает с разными часовыми поясами пользователей включая смену часовых поясов командой.

ОТКАЗОУСТОЙЧИВОСТЬ БЕЗ СОСТОЯНИЯ В ПАМЯТИ

Система не полагается на гарантированные интервальные проверки. После перезапуска, даунтайма или миграции бот анализирует базу данных, идентифицирует все пропущенные уведомления и немедленно отправляет их с задержкой, что предпочтительнее полного пропуска.

ДЕДУПЛИКАЦИЯ И УНИКАЛЬНОСТЬ

Ключ медикамента формируется из названия и времени приема. Дубликаты с идентичным названием и временем отклоняются жесткой логикой без участия LLM. другое время приема того же медикамента создает отдельную запись.

ТИПЫ КОМАНД И ОБРАБОТКА

первая ллм — это "классиффикатор", вторая — "парсер"

add: классификатор определяет намерение, парсер извлекает название медикамента, опциональную дозу и время приема или возвращает ошибку, жесткая логика проверяет дубликаты по названию и времени и отправляет сообщение пользователю если запись уже существует.

done: классификатор возвращает тип команды, система загружает расписание пользователя с уникальными ключами, парсер получает расписание и сообщение, возвращает либо список ключей принятых медикаментов либо уточняющее сообщение пользователю при неоднозначности, система записывает статус приема в базу данных по полученным ключам.
парсер корректно обрабатывает групповые отметки типа "все что в 17 часов принял", 

dose_change: классификатор определяет намерение изменения дозировки, парсер получает текущее расписание и сообщение пользователя, возвращает ключи медикаментов и новые значения дозировок или запрос уточнения.

delete: классификатор определяет намерение удаления, парсер получает расписание и сообщение, возвращает ключи для удаления или запрос уточнения.

time_change: классификатор определяет намерение изменения времени существующего медикамента, парсер получает расписание и сообщение, возвращает ключи и новое время приема, либо запрос уточнения.

timezone_change: классификатор определяет команду смены часового пояса, парсер извлекает новую таймзону или возвращает ошибку.

list: классификатор определяет запрос расписания по фразам типа "что я принимаю", "покажи расписание", "список", система формирует ответ жесткой логикой из базы данных без LLM.

help: классификатор распознает запрос помощи, система выдает преднастроенное сообщение без LLM.

unknown: при нераспознанной команде классификатор возвращает unknown, система отправляет сообщение "не понял" и "попробуй напиши помощь".

СТРУКТУРА БАЗЫ ДАННЫХ

Таблица медикаментов содержит user_id, название, дозу, время приема, часовой пояс, уникальный ключ, поле расписание/период для будущего расширения функции периодического приема. Таблица статусов приема хранит информацию о подтверждениях без детального логирования истории.

МОДУЛЬНАЯ ОРГАНИЗАЦИЯ КОДА

Простая немодульная архитектура без избыточного ООП. Один модуль соответствует одному файлу: модуль работы с LLM включающий промпты и парсеры, LLM-адаптер для конкретного API, Telegram-модуль для взаимодействия с ботом, scheduler/notifier для управления уведомлениями, модуль работы с базой данных, модуль работы с часовыми поясами, settings для ключей API и общих настроек из environment variables.

ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

Бот простой без планов развития, не энтерпрайз-решение. SQLite для хранения данных. Python как основной язык. Отсутствие необходимости в детальном логировании приемов и пропусков, пользователь нажимает "принято" для любого сценария включая намеренный пропуск.


!!!
все что в папке  src_old — это старый код, он не используется и спроектирован с ошибками, только для примера. оттуда можно переиспользовать только промпты